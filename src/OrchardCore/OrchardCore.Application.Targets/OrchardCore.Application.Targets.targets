<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    Defines msbuild tasks on a Bundle package to copy all modules assets (projects and packages) to the "Packages" folder.
  -->

  <Target Name="CopyPackageAssets" AfterTargets="AfterResolveReferences" Condition="'$(IgnorePackageAssets)' != 'true'">

    <Message Text="Copying package assets" Importance="high" />

    <ItemGroup>
      <ModuleProjectReferences
        Include="@(_MSBuildProjectReferenceExistent)"
        Condition="Exists('%(RootDir)%(Directory)Module.txt') Or Exists('%(RootDir)%(Directory)obj\Module.txt') Or
                   Exists('%(RootDir)%(Directory)Theme.txt') Or Exists('%(RootDir)%(Directory)obj\Theme.txt')" />
    </ItemGroup>

    <MSBuild
      Targets="GetProjectAssetFiles"
      BuildInParallel="$(BuildInParallel)"
      Projects="@(ModuleProjectReferences)"
      Condition="'@(ModuleProjectReferences)' != ''"
      ContinueOnError="true">

      <Output TaskParameter="TargetOutputs" ItemName="ProjectAssetFiles" />
    </MSBuild>

    <ItemGroup>
      <ModuleProjectNames Include="%(ModuleProjectReferences.FileName)" />
      <ModuleAssembliesNames Include="@(ModulePackageNames);@(ModuleProjectNames)" />
    </ItemGroup>

    <WriteLinesToFile
      File="obj\ModuleAssembliesNames.map"
      Lines="@(ModuleAssembliesNames)"
      Condition="'@(ModuleAssembliesNames)' != ''"
      Overwrite="true"
      Encoding="utf-8"
      ContinueOnError="true" />

    <ItemGroup>
      <EmbeddedResource Include="obj\ModuleAssembliesNames.map">
        <Link>ModuleAssembliesNames.map</Link>
        <CopyToOutputDirectory>Never</CopyToOutputDirectory>
      </EmbeddedResource>
    </ItemGroup>

    <!-- ======================================================================== -->

    <CreateItem Include="@(Content)" Condition="'%(Extension)'=='.cshtml'">
      <Output TaskParameter="Include" ItemName="MvcContentRazorFiles"/>
    </CreateItem>
    <ItemGroup Condition="'@(MvcRazorFilesToCompile)' == ''">
      <MvcRazorFilesToCompile Include="@(MvcContentRazorFiles);Modules\**\*.cshtml" />
    </ItemGroup>
  </Target>

  <!--
    Defines msbuild props and items on a Bundle package to publish all modules assets (projects and packages).
  -->

  <PropertyGroup>
    <MvcRazorExcludeViewFilesFromPublish>false</MvcRazorExcludeViewFilesFromPublish>
  </PropertyGroup>

</Project>